<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zoomable Interactive World Map</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background-color: #08070f;
      margin: 0;
      padding: 0;
      /* Force body to take exactly the window size */
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      /* Prevents scrollbars */
    }

    #map-container {
      /* Make container fill the entire body */
      width: 100%;
      height: 100%;
      position: relative;
    }

    .ocean {
      fill: #08070f;
      stroke: #110f1f;
      stroke-width: 3px;
      vector-effect: non-scaling-stroke;
    }

    .country {
      fill: #1d2434;
      /* Land color */
      stroke: #444b5b;
      stroke-width: 1px;
      vector-effect: non-scaling-stroke;
      transition: fill 0.2s;
      cursor: pointer;
    }

    .country:hover {
      fill: #92631d;
      /* Highlight on hover */
    }

    .country.selected {
      fill: #ff9800;
    }

    /* Tooltip styling */
    .tooltip {
      position: absolute;
      width: 2000px;
      text-align: center;
      padding: 8px 12px;
      font-size: 18px;
      font-weight: bold;
      background: rgba(3, 168, 30, 0.8);
      color: #fff;
      border-radius: 4px;
      pointer-events: none;
      opacity: 0;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      z-index: 10;
    }

    /* Styling for the flight path */
    .flight-path {
      fill: none;
      stroke: #ff3d00;
      /* Bright orange/red */
      stroke-width: 2px;
      stroke-dasharray: 4 4;
      /* Makes the line dashed */
      vector-effect: non-scaling-stroke;
      /* Keeps the line crisp when zooming */
      pointer-events: none;
      /* So it doesn't interfere with country clicks */
    }
  </style>
</head>

<body>

  <div id="map-container">
    <div class="tooltip" id="tooltip"></div>
  </div>

  <script>
    // Set dimensions for the SVG container
    const width = 1200;
    const height = 800;

    // Create the SVG element
    const svg = d3.select("#map-container")
      .append("svg")
      // NEW: viewBox defines the internal coordinate system
      .attr("viewBox", `0 0 ${width} ${height}`)
      // NEW: Tell the SVG to stretch visually to fit the container
      .style("width", "100%")
      .style("height", "100%");

    // Create a group for the map (required for semantic zooming)
    const g = svg.append("g");

    // Define the map projection (Natural Earth is visually pleasing for world maps)
    const projection = d3.geoNaturalEarth1()
      .scale(460)
      .translate([width / 2, height / 2]);

    // Define the path generator
    const path = d3.geoPath().projection(projection);

    // Select the tooltip
    const tooltip = d3.select("#tooltip");

    // Set up the Zoom behavior
    const zoom = d3.zoom()
      .scaleExtent([0.1, 148]) // Zoom limits: 1x to 8x
      .on("zoom", (event) => {
        g.attr("transform", event.transform);
      });

    // Apply the zoom behavior to the SVG
    svg.call(zoom);
    // Add a white sphere with a black border.

    // Optional: Hide tooltip when clicking on the background (ocean)
    svg.on("click", (event) => {
      if (event.target.tagName !== "path") {
        tooltip.style("opacity", 0);
      }
    });

    // Track the first clicked point
    let firstPoint = null;
    // Draw the background sphere (ocean and outline)
    g.append("path")
      .datum({ type: "Sphere" })
      .attr("class", "ocean")
      .attr("d", path);
    // Fetch the GeoJSON data for the world
    // src: https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson
    // const geojsonUrl = "./world.geojson";
    // const geojsonUrl = "https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_50m_admin_0_countries.geojson";
    const geojsonUrl = "./worldProcessed.geojson";

    d3.json(geojsonUrl).then(data => {
      // Draw the countries
      g.selectAll(".country")
        .data(data.features)
        .join("path")
        .attr("d", path)
        .attr("class", "country")
        // Handle the click event to show the popup
        .on("click", function (event, d) {
          event.stopPropagation();

          // Get the geographic center [longitude, latitude] of the clicked country
          const centroid = d3.geoCentroid(d);

          // Logic for connecting two countries
          if (!firstPoint) {
            // --- FIRST CLICK ---
            firstPoint = centroid;

            // Clear old lines and selections
            g.selectAll(".flight-path").remove();
            d3.selectAll(".country").classed("selected", false);

            // Highlight just this country
            d3.select(this).classed("selected", true);

          } else {
            // --- SECOND CLICK ---
            // Highlight the second country too
            d3.select(this).classed("selected", true);

            // Create a GeoJSON line from point A to point B
            const route = {
              type: "LineString",
              coordinates: [firstPoint, centroid]
            };

            // Draw the line on the map
            g.append("path")
              .datum(route)
              .attr("class", "flight-path")
              .attr("d", path);

            // Reset memory so the next click starts a brand new line
            firstPoint = null;
          }

          const countryName = d.properties.NAME || d.properties.ADMIN || d.properties.name;

          tooltip.style("opacity", 1)
            .html(countryName);

        })
        // Optional: Hide tooltip when the mouse leaves the country (if preferred over clicking elsewhere)
        .on("mouseleave", function () {
          // tooltip.style("opacity", 0);
        });
    }).catch(error => {
      console.error("Error loading the map data: ", error);
    });
  </script>
</body>

</html>